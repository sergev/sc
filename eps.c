/*
 *      SC - spreadsheet calculator, version 3.1.
 *
 *      (c) Copyright DEMOS, 1989
 *      All rights reserved.
 *
 *      Authors: Serg I. Ryshkov, Serg V. Vakulenko
 *
 *      Mon Jul 31 17:17:13 MSK 1989
 */

# include <stdio.h>

extern FILE *OutHard;

# define PLOT_KIAE

/*
 * Параметры для печати графиков на Epson-80
 */

# define NXS	500	/* Число точек по X */
# define NYS	500	/* Число точек по Y */

# define FACTOR 1.

# define PINS 7		/* число используемых игл */

# define NFL	((NYS+PINS-1)/PINS)

# define SP(x,y) _Field[(y)/PINS][x] |=   1<<(PINS-1-((y)%PINS))
# define CP(x,y) _Field[(y)/PINS][x] &= ~(1<<(PINS-1-((y)%PINS)))

# define SETPIX(x,y) {if(_Color) SP(x,NYS-1-(y)); else CP(x,NYS-1-(y));}

static float obotx = 0.;
static float oboty = 0.;
static float botx = 0.;
static float boty = 0.;
static float scalex = 1.;
static float scaley = 1.;

static char _Field [NFL] [NXS];
static int _circflag;
static int _Color = 1;
static int _OX, _OY;
static int _lptr = 0;
static int _dotpat = 0177777;

static char Font [] = {
0000,0000,0000,0000,0000,0000,0000,0000,0000,
0010,0010,0010,0010,0010,0010,0010,0000,0010,
0024,0024,0024,0000,0000,0000,0000,0000,0000,
0000,0101,0034,0042,0042,0042,0034,0101,0000,
0000,0024,0024,0177,0024,0177,0024,0024,0000,
0002,0105,0042,0020,0010,0004,0042,0121,0040,
0014,0022,0022,0014,0114,0062,0021,0061,0116,
0030,0020,0020,0010,0000,0000,0000,0000,0000,
0020,0010,0004,0004,0004,0004,0004,0010,0020,
0004,0010,0020,0020,0020,0020,0020,0010,0004,
0000,0010,0052,0034,0010,0034,0052,0010,0000,
0000,0000,0010,0010,0076,0010,0010,0000,0000,
0000,0000,0000,0000,0000,0000,0030,0020,0010,
0000,0000,0000,0000,0076,0000,0000,0000,0000,
0000,0000,0000,0000,0000,0000,0000,0030,0030,
0000,0100,0040,0020,0010,0004,0002,0001,0000,
0034,0042,0040,0121,0111,0105,0002,0042,0034,
0020,0030,0024,0020,0020,0020,0020,0020,0070,
0034,0042,0101,0100,0100,0060,0014,0002,0177,
0034,0042,0101,0100,0070,0100,0101,0042,0034,
0040,0060,0050,0044,0042,0041,0177,0040,0040,
0177,0001,0001,0037,0040,0100,0101,0042,0034,
0020,0010,0004,0002,0075,0101,0101,0042,0034,
0177,0100,0100,0040,0020,0010,0004,0002,0001,
0034,0042,0042,0034,0042,0101,0101,0042,0034,
0034,0042,0101,0101,0136,0040,0020,0010,0004,
0000,0030,0030,0000,0000,0000,0030,0030,0000,
0000,0030,0030,0000,0000,0000,0030,0020,0010,
0040,0020,0010,0004,0002,0004,0010,0020,0040,
0000,0000,0000,0076,0000,0076,0000,0000,0000,
0002,0004,0010,0020,0040,0020,0010,0004,0002,
0034,0042,0101,0100,0040,0020,0010,0000,0010,
0034,0042,0111,0125,0125,0125,0051,0002,0074,
0010,0024,0042,0101,0101,0177,0101,0101,0101,
0037,0041,0041,0021,0077,0101,0101,0101,0077,
0034,0042,0101,0001,0001,0001,0101,0042,0034,
0037,0041,0101,0101,0101,0101,0101,0041,0037,
0177,0001,0001,0001,0077,0001,0001,0001,0177,
0177,0001,0001,0001,0037,0001,0001,0001,0001,
0034,0042,0101,0001,0001,0161,0101,0102,0074,
0101,0101,0101,0101,0177,0101,0101,0101,0101,
0034,0010,0010,0010,0010,0010,0010,0010,0034,
0070,0020,0020,0020,0020,0020,0020,0022,0014,
0101,0041,0021,0011,0007,0011,0021,0041,0101,
0001,0001,0001,0001,0001,0001,0001,0001,0177,
0101,0143,0125,0111,0101,0101,0101,0101,0101,
0101,0101,0103,0105,0111,0121,0141,0101,0101,
0034,0042,0101,0101,0101,0101,0101,0042,0034,
0037,0041,0101,0101,0041,0037,0001,0001,0001,
0034,0042,0101,0101,0101,0101,0121,0042,0134,
0037,0041,0101,0101,0041,0037,0021,0041,0101,
0076,0101,0001,0001,0076,0100,0100,0101,0076,
0177,0010,0010,0010,0010,0010,0010,0010,0010,
0101,0101,0101,0101,0101,0101,0101,0042,0034,
0101,0101,0101,0101,0042,0042,0024,0024,0010,
0101,0101,0101,0101,0101,0111,0111,0125,0042,
0101,0101,0042,0024,0010,0024,0042,0101,0101,
0101,0101,0101,0042,0024,0010,0010,0010,0010,
0177,0100,0040,0020,0010,0004,0002,0001,0177,
0034,0004,0004,0004,0004,0004,0004,0004,0034,
0000,0001,0002,0004,0010,0020,0040,0100,0000,
0034,0020,0020,0020,0020,0020,0020,0020,0034,
0000,0000,0010,0024,0042,0000,0000,0000,0000,
0000,0000,0000,0000,0000,0000,0000,0000,0177,
0004,0010,0020,0000,0000,0000,0000,0000,0000,
0000,0000,0000,0074,0042,0042,0042,0042,0134,
0002,0002,0002,0002,0076,0102,0102,0102,0076,
0000,0000,0000,0074,0102,0002,0002,0102,0074,
0100,0100,0100,0100,0174,0102,0102,0102,0174,
0000,0000,0000,0074,0102,0102,0076,0002,0174,
0020,0050,0010,0034,0010,0010,0010,0010,0010,
0000,0000,0000,0074,0102,0102,0174,0100,0074,
0002,0002,0002,0002,0076,0102,0102,0102,0102,
0000,0010,0000,0010,0014,0010,0010,0010,0034,
0000,0020,0000,0020,0020,0020,0020,0024,0010,
0002,0002,0042,0022,0012,0016,0022,0042,0042,
0010,0014,0010,0010,0010,0010,0010,0010,0034,
0000,0000,0000,0045,0133,0111,0111,0111,0111,
0000,0000,0000,0072,0106,0102,0102,0102,0102,
0000,0000,0000,0074,0102,0102,0102,0102,0074,
0000,0000,0000,0076,0102,0102,0076,0002,0002,
0000,0000,0000,0174,0102,0102,0174,0100,0100,
0000,0000,0000,0072,0106,0002,0002,0002,0002,
0000,0000,0000,0074,0002,0074,0100,0102,0074,
0000,0000,0010,0034,0010,0010,0010,0010,0020,
0000,0000,0000,0042,0042,0042,0042,0042,0134,
0000,0000,0000,0101,0101,0101,0042,0024,0010,
0000,0000,0000,0101,0101,0101,0111,0125,0042,
0000,0000,0000,0102,0044,0030,0030,0044,0102,
0000,0000,0000,0042,0042,0024,0010,0010,0010,
0000,0000,0000,0176,0040,0020,0010,0004,0176,
0020,0010,0010,0010,0004,0010,0010,0010,0020,
0010,0010,0010,0010,0010,0010,0010,0010,0010,
0004,0010,0010,0010,0020,0010,0010,0010,0004,
0004,0052,0020,0000,0000,0000,0000,0000,0000,
0125,0052,0125,0052,0125,0052,0125,0052,0125,
0000,0000,0000,0062,0112,0116,0112,0112,0062,
0000,0000,0000,0034,0040,0074,0042,0042,0134,
0000,0040,0034,0002,0002,0076,0102,0102,0074,
0000,0000,0000,0042,0042,0042,0042,0134,0100,
0000,0000,0000,0070,0044,0044,0044,0176,0102,
0000,0000,0000,0176,0002,0076,0002,0002,0176,
0000,0000,0000,0076,0111,0111,0111,0076,0010,
0000,0000,0000,0176,0002,0002,0002,0002,0002,
0000,0000,0000,0102,0044,0030,0030,0044,0102,
0000,0000,0000,0102,0142,0122,0112,0106,0102,
0000,0000,0030,0102,0142,0122,0112,0106,0102,
0000,0000,0000,0042,0022,0016,0022,0042,0102,
0000,0000,0000,0160,0110,0110,0110,0104,0102,
0000,0000,0000,0101,0143,0125,0111,0101,0101,
0000,0000,0000,0102,0102,0176,0102,0102,0102,
0000,0000,0000,0074,0102,0102,0102,0102,0074,
0000,0000,0000,0176,0102,0102,0102,0102,0102,
0000,0000,0000,0174,0102,0102,0174,0104,0102,
0000,0000,0000,0076,0102,0102,0076,0002,0002,
0000,0000,0000,0174,0002,0002,0002,0002,0174,
0000,0000,0000,0076,0010,0010,0010,0010,0010,
0000,0000,0000,0102,0102,0102,0174,0100,0074,
0000,0000,0000,0111,0052,0034,0034,0052,0111,
0000,0000,0000,0076,0102,0076,0102,0102,0076,
0000,0000,0000,0002,0002,0076,0102,0102,0076,
0000,0000,0000,0102,0102,0116,0122,0122,0116,
0000,0000,0000,0074,0102,0060,0100,0102,0074,
0000,0000,0000,0111,0111,0111,0111,0111,0177,
0000,0000,0000,0076,0100,0160,0100,0100,0076,
0000,0000,0000,0111,0111,0111,0111,0177,0100,
0000,0000,0000,0102,0102,0102,0174,0100,0100,
0000,0000,0000,0006,0004,0074,0104,0104,0074,
0071,0105,0105,0105,0107,0105,0105,0105,0071,
0160,0110,0104,0102,0101,0177,0101,0101,0101,
0177,0001,0001,0001,0077,0101,0101,0101,0077,
0041,0041,0041,0041,0041,0041,0041,0177,0100,
0070,0044,0042,0042,0042,0042,0042,0177,0101,
0177,0001,0001,0001,0077,0001,0001,0001,0177,
0076,0111,0111,0111,0111,0076,0010,0010,0010,
0177,0001,0001,0001,0001,0001,0001,0001,0001,
0101,0101,0042,0024,0010,0024,0042,0101,0101,
0101,0101,0101,0141,0121,0111,0105,0103,0101,
0125,0111,0101,0141,0121,0111,0105,0103,0101,
0101,0041,0021,0011,0037,0041,0101,0101,0101,
0170,0104,0102,0102,0102,0102,0102,0102,0101,
0101,0143,0125,0111,0101,0101,0101,0101,0101,
0101,0101,0101,0101,0177,0101,0101,0101,0101,
0076,0101,0101,0101,0101,0101,0101,0101,0076,
0177,0101,0101,0101,0101,0101,0101,0101,0101,
0176,0101,0101,0101,0176,0110,0104,0102,0101,
0077,0101,0101,0101,0077,0001,0001,0001,0001,
0076,0101,0001,0001,0001,0001,0001,0101,0076,
0177,0010,0010,0010,0010,0010,0010,0010,0010,
0101,0101,0101,0101,0176,0100,0100,0100,0077,
0111,0111,0111,0052,0034,0052,0111,0111,0111,
0077,0101,0101,0101,0077,0101,0101,0101,0077,
0001,0001,0001,0001,0077,0101,0101,0101,0077,
0101,0101,0101,0101,0117,0121,0121,0121,0117,
0076,0101,0100,0100,0070,0100,0100,0101,0076,
0111,0111,0111,0111,0111,0111,0111,0111,0177,
0037,0040,0100,0100,0170,0100,0100,0040,0037,
0111,0111,0111,0111,0111,0111,0111,0177,0100,
0101,0101,0101,0101,0176,0100,0100,0100,0100,
0007,0004,0004,0004,0074,0104,0104,0104,0074,
};

# ifdef __MSDOS__
static local1 [48] = {
        0341, 0342, 0367, 0347, 0344, 0345, 0366, 0372,	/* абвгдежз */
	0351, 0352, 0353, 0354, 0355, 0356, 0357, 0360, /* ийклмноп */
	0362, 0363, 0364, 0365, 0346, 0350, 0343, 0376, /* рстуфхцч */
	0373, 0375, 0277, 0371, 0370, 0374, 0340, 0361, /* шщъыьэюя */
        0301, 0302, 0327, 0307, 0304, 0305, 0326, 0332,	/* абвгдежз */
	0311, 0312, 0313, 0314, 0315, 0316, 0317, 0320, /* ийклмноп */
};

static local2 [16] = {
	0322, 0323, 0324, 0325, 0306, 0310, 0303, 0336, /* рстуфхцч */
	0333, 0335, 0337, 0331, 0330, 0334, 0300, 0321, /* шщъыьэюя */
};
# endif

/*
 * Установка размещения области рисования на Epson-80
 * by @VG
 */

h_space(x0,y0,x1,y1)
{
	boty = 0.;
	obotx = x0;
	oboty = y0;
# ifndef PLOT_KIAE
	scalex = ((float)NXS)/(x1-x0);
	scaley = ((float)NYS)/(y1-y0);
# else
	scaley = scalex = ((float)NXS)/(x1-x0);
	if( (y1-y0)*scalex*FACTOR > ((float)NYS) )
		scaley = scalex = ((float)NYS)/(((float)(y1-y0))*FACTOR);
# endif
	botx = 0.;     /* Moves graph area to left ... */
}

/*
 * Рисование дуги - Epson-80
 * by @VG
 */
h_arc(cx, cy, x0, y0, x1, y1)
{
	register x, y;
	int D, d1, d2, d3, dd1, dd2, dd3;
	extern int _lptr, _dotpat;
	int snt, dx, dy;

	_convert(&cx, &cy);
	_convert(&x0, &y0);
	_convert(&x1, &y1);

	if( ! _circflag && x0-x1 <= 2 && x0-x1 >= -2 && y0-y1 <= 2 && y0-y1 >= -2 ) {
		SETPIX( x0, y0 );
		SETPIX( (x0+x1)/2, (y0+y1)/2 );
		SETPIX( x1, y1 );
		return;
	}
	_circflag = 0;

	x = x0; y = y0;

	for( D = 0, snt = 0;; ) {
		if( (_dotpat & (1<<_lptr)) && x >= 0 && x < NXS &&
					      y >= 0 && y < NYS )
			SETPIX(x, y);
		_lptr++; _lptr &= 017;

		d1 = x-x1; if( d1 < 0 ) d1 = -d1;
		d2 = y-y1; if( d2 < 0 ) d2 = -d2;
		if( d1+d2 <= 1 && snt > 2 ) break;
		if( snt++ > 2000 ) break;

		dx = (y < cy)?  1 : -1;
		dy = (x < cx)? -1 :  1;
		d1 = dd1 = D + 1 + 2*dx*(x-cx);
		d2 = dd2 = D + 1 + 2*dy*(y-cy);
		d3 = dd3 = d1+d2-D;
		if( dd1 < 0 ) dd1 = -dd1;
		if( dd2 < 0 ) dd2 = -dd2;
		if( dd3 < 0 ) dd3 = -dd3;
		if( dd1 < dd2 ) {
			if( dd3 < dd1 ) { x += dx; y += dy; D = d3; }
			else            { x += dx;          D = d1; }
		} else {
			if( dd3 < dd2 ) { x += dx; y += dy; D = d3; }
			else            {          y += dy; D = d2; }
		}
	}
	SETPIX(x1, y1);
}

/*
 * Рисование окружности - Epson-80
 * by @VG
 */

h_circle(x, y, r)
{
	_circflag = 1;
	h_arc(x,y,x+r,y,x+r,y);
}

h_closepl()
{
	register int i, maxi;
	int l;

	/*
	 * Вывод битовой карты в режиме Plotter Graphic (1/72")
	 */

	for( l = 0 ; l < NFL ; l++ ) {
		for( maxi = NXS-1; maxi >= 0; maxi-- )
			if( _Field[l][maxi] ) break;
		if( maxi >= 0 ) {
			maxi++;
# if PINS != 8
			if( maxi & 0200 )
				maxi = (maxi + 0400) & ~0377;
# endif
			putc( 033, OutHard );
			putc( '*', OutHard );
			putc( 5, OutHard );   /* 1/72" */
			putc( maxi & 0377, OutHard );
			putc( maxi >> 8, OutHard );
			for( i = 0; i < maxi ; i++ ) {
				putc( (i<NXS)? _Field[l][i] : 0, OutHard );
			}
		}
		putc( 012, OutHard );
		putc( 015, OutHard );
	}
}

h_color(col)
{
	_Color = col;
}

/*
 * Очистка экрана - Epson-80
 * by @VG
 */

h_erase()
{
	register int *p, *q;

	p = (int *)_Field;
	q = (int *)((char *)_Field + NFL*NXS);
	while( p < q )
		*p++ = 0;
}

static char *fontindex (c)
{
	register char *p;

	if (c>=040 && c<0200)
		return (& Font [(c-040) * 9]);
# ifdef __MSDOS__
	if (c >= 0200 && c <= 0257)
		c = local1 [c - 0200];
	else if (c >= 0340 && c <= 0357)
		c = local2 [c - 0340];
# else
	if (c > 0277)
		c = c;
# endif
	else
		return (0);
	return (& Font [(c-0300+0200-040) * 9]);
}

/*
 * Рисование текста - Epson-80
 * by @VG
 */

h_label(s)
register char *s;
{
	int c, ny;
	extern int _OX, _OY;
	int x = _OX, y = _OY;
	register char *p;
	register ix, iy;
	static COX = -1, COY = -1;
	static six, siy;

	if( COX != _OX || COY != _OY ) {
		_convert( &x, &y );
		COX = _OX; COY = _OY;
		x -= 3; y += 4;         /* centering letter's boxes */
		six = x; siy = y;
		if( siy < 9 ) siy = 9;
		if( siy >= NYS ) siy = NYS-1;
		if( six < 0 ) six = 0;
	}
	while( c = *s++ ) {
		c &= 0377;
		if (! (p = fontindex (c)))
			continue;
		if( six >= NXS-7 ) break;
		for(ny = 0 ; ny < 9 ; ny++) {
			iy = siy - ny;
			c = *p++;
			for( ix = 0 ; ix < 7 ; ix++ ) {
				if(c & 01)
					SETPIX(ix+six, iy);
				c >>= 1;
			}
		}
		six += 8;
	}
}

/*
 * Рисование линии - Epson-80
 * by @VG
 */

h_line(x0,y0,x1,y1)
{
	h_move(x0, y0);
	h_cont(x1, y1);
}

/*
 * Установка типа линии - Epson-80
 * by @VG
 */

h_linemod(s)
char *s;
{
	_lptr = 0;
	if(      !strcmp(s, "dotted") )
		_dotpat = 052525;
	else if( !strcmp(s, "dotdashed") )
		_dotpat = 0377 | (3<<11);
	else if( !strcmp(s, "shortdashed") )
		_dotpat = 017 | (017<<8);
	else if( !strcmp(s, "longdashed") )
		_dotpat = 0377;
	else /* solid */
		_dotpat = 0177777;
}

/*
 * Установка текущей позиции - Epson-80
 * by @VG
 */

h_move(x, y)
{
	_OX = x; _OY = y;
	_lptr = 0;
}

h_openpl()
{
	putc(033, OutHard); putc('A', OutHard); putc(PINS, OutHard); /* PINS*1/72" shift */
	putc(033, OutHard); putc('E', OutHard);                /* font ELITA  (1/12") */
}

/*
 * Рисование точки - Epson-80
 * by @VG
 */

h_point(x, y)
{
	_OX = x; _OY = y;
	_convert(&x, &y);
	SETPIX(x, y);
	_lptr = 0;
}

/*
 * Процедуры вывода линии и точки на Epson-80
 * by @VG
 */

h_cont(x1 ,y1)
{
	register x, y;
	int a, b, D, dx, dy, dd1, dd2, dd3;

	_convert(&_OX, &_OY);
	x = _OX; y = _OY;
	_OX = x1; _OY = y1;
	_convert(&x1, &y1);

	b = x1 - x;
	a = y1 - y;
	if( a < 0 ) a = -a;
	if( b > 0 ) b = -b;
	dx = (x > x1)? -1 : 1;
	dy = (y > y1)? -1 : 1;
	D = 0;
	while( x != x1 || y != y1 ) {
		if( _dotpat & (1<<_lptr) )
			SETPIX(x, y);
		_lptr++; _lptr &= 017;
		dd1 = D + a;
		dd2 = D + b;
		dd3 = dd1 + b;
		if( dd1 < 0 ) dd1 = -dd1;
		if( dd2 < 0 ) dd2 = -dd2;
		if( dd3 < 0 ) dd3 = -dd3;
		if( dd1 < dd2 ) {
			if( dd3 < dd1 )
				x += dx, y += dy, D += a+b;
			else
				x += dx, D += a;
		} else {
			if( dd3 < dd2 )
				x += dx, y += dy, D += a+b;
			else
				y += dy, D += b;
		}
	}
	SETPIX(x, y);
}

static _convert(x, y)
int *x, *y;
{
	register ix, iy;

	ix = (*x-obotx)*scalex + botx;
	iy = (*y-oboty)*scaley + boty;
	if( ix < 0 )     ix = 0;
	if( ix > NXS-1 ) ix = NXS-1;
	if( iy < 0 )     iy = 0;
	if( iy > NYS-1 ) iy = NYS-1;
	*x = ix;
	*y = iy;
}

h_mapcolor(a,b,c,d)
{
	a = a; b = b; c = c; d = d;
}

h_dot(a,b,c,d,e)
{
	a = a; b = b; c = c; d = d; e = e;
}

h_charsize( x,y )
int *x, *y;
{
	*x = (int)(8./scalex)+1;
	*y = (int)(10./(FACTOR*scaley))+1;
}
